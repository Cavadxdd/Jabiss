@using Jabiss.Web.Models.Products
@model ProductViewModel

@{
    Layout = "~/Views/Shared/_AdminPanelLayout.cshtml";
}

<h4 class="mb-3">Products</h4>

@if (ViewData["SuccessMessage"] != null)
{
    <div class="alert alert-success" role="alert">
        @ViewData["SuccessMessage"]
    </div>
}

<p>
    <a class="btn btn-primary" asp-controller="Products" asp-action="Create">Create New</a>
</p>

<table class="table table-striped">
    <thead>
        <tr>
            <th>No</th>
            <th>Name</th>
            <th>Description</th>
            <th>Price</th>
            <th>Stock</th>
            <th>CategoryId</th>
            <th>Images</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        @for (int i = 0; i < Model.Products.Count; i++)
        {
            var product = Model.Products[i];
            <tr>
                <td>@(i + 1)</td>
                <td>@product.Name</td>
                <td>@product.Description</td>
                <td>@product.Price</td>
                <td>@product.Stock</td>
                <td>@product.CategoryId</td>
                <td>
                    <div class="image-container">
                        @{
                            var firstImage = product.Images.FirstOrDefault();
                            if (firstImage != null)
                            {
                                <div class="image-wrapper" style="display: inline-block; margin-right: 10px;">
                                    <img src="data:image/jpeg;base64,@Convert.ToBase64String(firstImage.ImageData)"
                                         alt="@product.Name" style="width: 100px; height: auto;" />
                                </div>
                            }
                        }
                    </div>
                </td>

                <td>
                    <a asp-controller="Products" asp-action="Edit" asp-route-id="@product.Id" class="btn btn-sm btn-warning">Edit</a>
                    <button class="btn btn-danger btn-sm"
                            data-bs-toggle="modal"
                            data-bs-target="#deleteProductModal"
                            data-product-id="@product.Id"
                            data-product-name="@product.Name"
                            data-product-description="@product.Description"
                            data-product-price="@product.Price"
                            data-product-stock="@product.Stock"
                            data-product-categoryId="@product.CategoryId">
                        Delete
                    </button>
                </td>
            </tr>
        }
    </tbody>
</table>

<div class="modal fade" id="deleteProductModal" tabindex="-1" aria-labelledby="deleteProductModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post" asp-action="Delete">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteProductModalLabel">Delete Product</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete the following Product?</p>
                    <ul>
                        <li><strong>Name:</strong> <span id="modalProductName"></span></li>
                        <li><strong>Description:</strong> <span id="modalProductDescription"></span></li>
                        <li><strong>Price:</strong> <span id="modalProductPrice"></span></li>
                        <li><strong>Stock:</strong> <span id="modalProductStock"></span></li>
                        <li><strong>CategoryId:</strong> <span id="modalProductCategoryId"></span></li>
                    </ul>
                    <input type="hidden" name="Id" id="modalProductId" />
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">Delete</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const deleteModal = document.getElementById('deleteProductModal');
        deleteModal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            const id = button.getAttribute('data-product-id');
            const name = button.getAttribute('data-product-name');
            const description = button.getAttribute('data-product-description');
            const price = button.getAttribute('data-product-price');
            const stock = button.getAttribute('data-product-stock');
            const categoryId = button.getAttribute('data-product-categoryId');

            document.getElementById('modalProductId').value = id;
            document.getElementById('modalProductName').textContent = name;
            document.getElementById('modalProductDescription').textContent = description;
            document.getElementById('modalProductPrice').textContent = price;
            document.getElementById('modalProductStock').textContent = stock;
            document.getElementById('modalProductCategoryId').textContent = categoryId;
        });

        $('.delete-image').on('click', function () {
            if (confirm('Are you sure you want to delete this image?')) {
                const productId = $(this).data('product-id');
                const imageId = $(this).data('image-id');
                $.post('/Products/DeleteImage', { productId: productId, imageId: imageId }, function () {
                    location.reload();
                });
            }
        });
    </script>
}